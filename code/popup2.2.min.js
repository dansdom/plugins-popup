/*
	jQuery Popup Plugin 
	Copyright (c) 2011 Daniel Thomson
	
	Licensed under the MIT license:
	http://www.opensource.org/licenses/mit-license.php
*/
(function(b){b.Popup=function(a,e,d){this.el=b(e);this.namespace="popup";this.opts=b.extend(!0,{},b.Popup.settings,a);this.init();"function"===typeof d&&d.call()};b.Popup.settings={transparentLayer:!0,transparentOpacity:70,gallery:!1,galleryCounter:!1,titleHeight:30,controlHeight:40,imageDesc:!1,autoSize:!0,boxWidth:400,boxHeight:300,centerImage:!0,shadowLength:42,transition:500,popupID:"popupBox",contentClass:"popupContent",closeBox:"popupClose",hasCloseButton:!0,centerOnResize:!0,loaderPath:"loader.gif", overflow:"visible",ajax:!1,ajaxType:"text",fixedTop:!1,fixedLeft:!1,onOpen:function(){},onClose:function(){}};b.Popup.prototype={init:function(){var a=this;this.destroy();this.el.isOpen=!1;this.el.boxSrc=this.el.attr("name");this.opts.gallery||(this.fragment=b(this.el.boxSrc));this.el.closeBtn=this.opts.hasCloseButton?'<a href="" class="'+this.opts.closeBox+'">close</a>':"";b(this.el).on("click."+this.namespace,function(b){b.preventDefault();a.openBox()})},findScreenPos:function(){var a={},e=b(window); a.winY=e.height();a.winX=e.width();a.scrY=e.scrollTop();a.scrX=e.scrollLeft();return a},createBox:function(){var a=this,e,d;0===b("#"+this.opts.popupID).length&&(e='<div id="'+this.opts.popupID+'"><table cellpadding="0" cellspacing="0"><tbody><tr class="popupTop"><td class="popupTL corner pngbg"></td><td class="popupTM pngbg"></td><td class="popupTR corner pngbg"></td></tr><tr class="popupMid"><td class="popupML pngbg"></td><td class="'+this.opts.contentClass+'"></td><td class="popupMR pngbg"></td></tr><tr class="popupBot"><td class="popupBL corner pngbg"></td><td class="popupBM pngbg"></td><td class="popupBR corner pngbg"></td></tr></tbody></table></div>', b("body").append(e),b("#"+this.opts.popupID).css("display","none"));!0===this.opts.transparentLayer&&0===b(".transparency").length&&(e='<div class="transparency" style="z-index:99;background:#000;opacity:'+this.opts.transparentOpacity/100+";filter:alpha(opacity = "+this.opts.transparentOpacity+');top:0;left:0;position:absolute"></div>',b("body").append(e),b(window).on("scroll."+this.namespace,function(){d=a.findScreenPos();b(".transparency").css({height:d.winY+d.scrY,width:d.winX+d.scrX})}),b(window).on("resize."+ this.namespace,function(){d=a.findScreenPos();b(".transparency").css({height:d.winY+d.scrY+"px",width:d.winX+d.scrX+"px"})}));!1===this.opts.transparentLayer&&0<b(".transparency").length&&b(".transparency").remove();b(document).on("keydown."+this.namespace,function(b){27==b.keyCode&&!0===a.el.isOpen&&a.closeBox()});b(".transparency").on("click."+this.namespace,function(){!0===a.el.isOpen&&a.closeBox()});b("#"+this.opts.popupID+" ."+this.opts.contentClass).children().remove();d=this.findScreenPos(); b(".transparency").css({display:"block",filter:"alpha(opacity = "+this.opts.transparentOpacity+")",opacity:this.opts.transparentOpacity/100,height:d.winY+d.scrY+"px",width:d.winX+d.scrX+"px"})},styleBox:function(a,e){var d=this,c=b("#"+this.opts.popupID),g="."+this.opts.contentClass+" img",f,k,l,h,n,p,m,q,r;e&&(b(g).attr("src",e.src),b(g).attr("height",a.imgHeight+"px"),b(g).attr("width",a.imgWidth+"px"));a?(g=a.imgHeight+this.opts.titleHeight+this.opts.controlHeight,f=a.imgWidth,!1===this.opts.autoSize&& (g=this.opts.boxHeight+this.opts.titleHeight+this.opts.controlHeight,f=this.opts.boxWidth)):(g=this.opts.boxHeight,f=this.opts.boxWidth);k=f+2*this.opts.shadowLength;l=g+2*this.opts.shadowLength;m=d.findScreenPos();h=this.centerBox(m,k,l);this.opts.fixedTop&&(h.topPos=this.opts.fixedTop);this.opts.fixedLeft&&(h.leftPos=h.fixedLeft);p=h.topPos;n=h.leftPos;if(!0===this.opts.centerOnResize)b(window).on("resize."+this.namespace,function(){m=d.findScreenPos();h=d.centerBox(m,k,l);d.opts.fixedTop&&(h.topPos= d.opts.fixedTop);d.opts.fixedLeft&&(h.leftPos=h.fixedLeft);c.css({top:h.topPos+"px",left:h.leftPos+"px"})});"block"===c.css("display")&&a&&!0===this.opts.autoSize?(q=parseFloat(c.css("height"))-2*this.opts.shadowLength-(this.opts.titleHeight+this.opts.controlHeight),r=parseFloat(c.css("width"))-2*this.opts.shadowLength,c.find(".galleryTitle").css({height:this.opts.titleHeight+"px"}),c.find(".galleryControls").css({height:this.opts.controlHeight+"px",overflow:this.opts.overflow}),c.find("img").css({height:q+ "px",width:r+"px"}),c.find(".imgPane").css({width:"100%"}),c.find("img").animate({height:a.imgHeight+"px",width:a.imgWidth+"px"},{queue:!1,duration:this.opts.transition}),c.animate({height:l+"px",width:k+"px",left:n+"px",top:p+"px"},{queue:!1,duration:this.opts.transition}),c.find(".imgPane").animate({height:g-this.opts.titleHeight-this.opts.controlHeight+"px"},{queue:!1,duration:this.opts.transition}),c.find(".popupContent").animate({height:g+"px",width:f+"px"},{queue:!1,duration:this.opts.transition}), c.find(".popupTM, .popupBM").animate({width:a.imgWidth+"px"},{queue:!1,duration:this.opts.transition})):(c.css({height:l+"px",width:k+"px",position:"absolute","z-index":100,overflow:this.opts.overflow}),c.find(".imgPane").css({height:g-this.opts.titleHeight-this.opts.controlHeight+"px"}),c.find(".popupContent").css({height:g+"px",width:f+"px"}),c.find(".popupML div, .popupMR div").css({height:g+"px"}),c.find(".galleryTitle").css({height:this.opts.titleHeight+"px",overflow:this.opts.overflow}),c.find(".galleryControls").css({height:this.opts.controlHeight+ "px",overflow:this.opts.overflow}),c.find(".corner").css({height:this.opts.shadowLength+"px",width:this.opts.shadowLength+"px"}),c.find(".popupTM").css({height:this.opts.shadowLength+"px",width:f+"px"}),c.find(".popupBM").css({height:this.opts.shadowLength+"px",width:f+"px"}),c.css({left:n+"px",top:p+"px"}));c.fadeIn("slow")},centerBox:function(a,b,d){var c={};c.leftPos=(a.winX-b)/2+a.scrX;c.topPos=(a.winY-d)/2+a.scrY;0>c.topPos&&(c.topPos=0);0>c.leftPos&&(c.leftPos=0);return c},isContentImage:function(){var a= this.el.boxSrc.split(".");switch(a[a.length-1]){case "jpg":a=!0;break;case "gif":a=!0;break;case "png":a=!0;break;case "bmp":a=!0;break;default:a=!1}return a},displayImage:function(){var a=this,e,d,c,g={},f=b("#"+this.opts.popupID+" ."+this.opts.contentClass);f.append('<div class="imgPane"><img class="loader" src="'+this.opts.loaderPath+'" width="" height="" alt="" /></div>');!0===this.opts.imageDesc&&b(".imgPane").css("position","relative").append('<div class="imageDesc" style="position:absolute;bottom:0;left:0;width:100%;background:#000;opacity:0.8;filter:alpha(opacity = 80);">'+ this.el.imageDesc+"</div>");!1===this.opts.autoSize&&!0===this.opts.centerImage&&(f.find(".imgPane").prepend("<span style='display:inline-block;height:"+this.opts.boxHeight+"px;line-height:"+this.opts.boxHeight+"px;width:1px'>&nbsp;</span>"),f.find(".imgPane").css({"line-height":this.opts.boxHeight+"px","text-align":"center"}),f.find(".imgPane img").css({display:"inline","vertical-align":"middle"}));!0===this.opts.gallery&&(!1!==this.el.galleryTitle?(f.append('<div class="galleryControls"><a href="" class="prev">previous</a><a href="" class="next">next</a></div>'), f.prepend('<div class="galleryTitle"><h2>'+this.el.galleryTitle+"</h2>"+this.el.closeBtn+"</div>"),!0===this.opts.galleryCounter&&(e=b("*[title='"+this.el.galleryTitle+"']").index(this.el)+1,d=b("*[title='"+this.el.galleryTitle+"']").length,f.find(".galleryControls").append("<p class='galleryCounter'>Displaying "+e+" of "+d+"</p>"))):f.prepend('<div class="galleryTitle">'+this.el.closeBtn+"</div>"));c=new Image;c.onload=function(){g.imgHeight=c.height;g.imgWidth=c.width;a.styleBox(g,c)};c.src=this.el.boxSrc; this.addCloseButton();this.addGalleryControls()},styleNodeBox:function(){var a=b("#"+this.opts.popupID+" ."+this.opts.contentClass);a.find("img.loader").remove();a.append('<div class="galleryTitle">'+this.el.closeBtn+"</div>");a.append(this.fragment);a.find(this.el.boxSrc).css("display","block");this.styleBox();this.addCloseButton()},getAjaxContent:function(){var a=this;b("#"+this.opts.popupID+" ."+this.opts.contentClass).html('<img class="loader" src="'+this.opts.loaderPath+'" width="" height="" alt="" />'); b.ajax({url:a.el.boxSrc,dataType:a.opts.ajaxType,success:function(b){a.fragment=b;a.styleNodeBox()},error:function(){a.fragment="ajax request failed";a.styleNodeBox()}})},addGalleryControls:function(){var a=this;b("#"+this.opts.popupID+" .next").on("click."+this.namespace,function(){a.cycleImage(1);return!1});b("#"+this.opts.popupID+" .prev").on("click."+this.namespace,function(){a.cycleImage(-1);return!1});b(document).on("keydown."+this.namespace,function(b){39==b.keyCode&&!0===a.el.isOpen?a.cycleImage(1): 37==b.keyCode&&!0===a.el.isOpen&&a.cycleImage(-1);27==b.keyCode&&!0===a.el.isOpen&&a.closeBox()})},addCloseButton:function(){var a=this;b("#"+a.opts.popupID+" ."+a.opts.closeBox).on("click."+a.namespace,function(){!0===a.el.isOpen&&a.closeBox();return!1})},openBox:function(){this.el.galleryTitle=b(this.el).attr("title");this.el.imageDesc=b(this.el).attr("longdesc");this.createBox();var a=this.findScreenPos();this.el.winY=a.winY;this.el.winX=a.winX;this.el.scrY=a.scrY;this.el.scrX=a.scrX;this.isContentImage()? this.displayImage():!0===this.opts.ajax?this.getAjaxContent():this.styleNodeBox();if(!1===this.el.isOpen)this.opts.onOpen();this.el.isOpen=!0},closeBox:function(){b("#"+this.opts.popupID).stop().fadeOut("slow").css("display","none");b("#"+this.opts.popupID).remove();b(".transparency").fadeOut("slow");if(!0===this.el.isOpen)this.opts.onClose();b(document).off("keydown."+this.namespace);this.el.isOpen=!1},cycleImage:function(a){var e=b("*[title='"+this.el.galleryTitle+"']").index(this.el),d=b("*[title='"+ this.el.galleryTitle+"']").length;a=e+a;0>a&&(a=d-1);a==d&&(a=0);this.el.isOpen=!1;b(document).off("keydown."+this.namespace);b("*[title='"+this.el.galleryTitle+"']:eq("+a+")").popup("openBox")},option:function(a){this.opts=b.extend(!0,{},this.opts,a)},changeContent:function(a){this.fragment=b(a)},setFragmentHtml:function(a){this.fragment.html(a)},destroy:function(){this.el.off("."+this.namespace)}};b.fn.popup=function(a,e){var d;"string"===typeof a?(d=Array.prototype.slice.call(arguments,1),this.each(function(){var c= b.data(this,"popup");c?b.isFunction(c[a])&&"_"!==a.charAt(0)?c[a].apply(c,d):alert("the plugin contains no such method: "+a):alert("The plugin has not been initialised yet when you tried to call this method: "+a)})):this.each(function(){var c=b.data(this,"popup");c?c.option(a):b.data(this,"popup",new b.Popup(a,this,e))});return this}})(jQuery);